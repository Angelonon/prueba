name: Forge2D Game rebuild script
steps:
  - name: step_03
    steps:
      - name: Remove generated code
        rmdir: step_03
      - name: Create project
        flutter: create --empty forge2d_game 
      - name: Make the macOS titlebar transparent, content full window, and hide the title bar.
        full-screen-macos-main-menu-xib: forge2d_game/macos/Runner/Base.lproj/MainMenu.xib
      - name: Strip DEVELOPMENT_TEAM
        strip-lines-containing: DEVELOPMENT_TEAM =
        path: forge2d_game/ios/Runner.xcodeproj/project.pbxproj
      - name: Configure analysis_options.yaml
        path: forge2d_game/analysis_options.yaml
        replace-contents: |
          include: ../../analysis_options.yaml
          
          analyzer:
            language:
              strict-inference: false
          
          linter:
            rules:
              prefer_const_constructors: false
              sort_pub_dependencies: true
      - name: Remove README
        rm: forge2d_game/README.md
      - name: Add .vscode directory
        mkdir: forge2d_game/.vscode
      - name: Add .vscode/launch.json
        path: forge2d_game/.vscode/launch.json
        replace-contents: |
          {
              // Use IntelliSense to learn about possible attributes.
              // Hover to view descriptions of existing attributes.
              // For more information, visit: https://go.microsoft.com/fwlink/?linkid=830387
              "version": "0.2.0",
              "configurations": [
                  {
                      "name": "forge2d_game",
                      "request": "launch",
                      "type": "dart"
                  }
              ]
          }
      - name: Add dependencies
        path: forge2d_game
        flutter: pub add flame flame_forge2d
      - name: fix pubspec.yaml ordering
        path: forge2d_game/pubspec.yaml
        patch: |
          --- b/forge2d_game/step_03/pubspec.yaml
          +++ a/forge2d_game/step_03/pubspec.yaml
          @@ -13,9 +13,9 @@ dependencies:
               sdk: flutter
           
           dev_dependencies:
          +  flutter_lints: ^3.0.0
             flutter_test:
               sdk: flutter
          -  flutter_lints: ^3.0.0
           
           flutter:
             uses-material-design: true
      - name: Replace lib/main.dart
        path: forge2d_game/lib/main.dart
        replace-contents: |                    
          // Copyright 2024 The Flutter Authors. All rights reserved.
          // Use of this source code is governed by a BSD-style license that can be
          // found in the LICENSE file.

          import 'package:flame/game.dart';
          import 'package:flame_forge2d/flame_forge2d.dart';
          import 'package:flutter/material.dart';

          void main() {
            final game = Forge2DGame();
            runApp(GameWidget(game: game));
          }

      - name: Build iOS simulator bundle
        platforms: [ macos ]
        path: forge2d_game
        flutter: build ios --simulator
      - name: Build Android APK
        platforms: [ macos ]
        path: forge2d_game
        flutter: build apk
      - name: Build macOS app
        platforms: [ macos ]
        path: forge2d_game
        flutter: build macos
      - name: Build Linux app
        platforms: [ linux ]
        path: forge2d_game
        flutter: build linux
      - name: Build Windows app
        platforms: [ windows ]
        path: forge2d_game
        flutter: build windows
      - name: Copy step_03
        copydir:
          from: forge2d_game
          to: step_03
      - name: Flutter clean
        path: step_03
        flutter: clean
  - name: step_04
    steps:
      - name: Remove generated code
        rmdir: step_04

      - name: Copy step_04
        copydir:
          from: forge2d_game
          to: step_04
      - name: Flutter clean
        path: step_04
        flutter: clean
  - name: Cleanup
    rmdir: forge2d_game

